<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Temperatura de Gasapos</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    h1 {
      color: green; /* Letras verdes para el título */
    }
  </style>
</head>
<body>
  <h1>Temperatura de Gasapos</h1>
  <div>
    <canvas id="temperatureChart" width="400" height="200"></canvas>
  </div>
  <br>
  <h3>Selecciona el día</h3>
  <input type="date" id="datePicker">
  <button onclick="filterData()">Mostrar Temperatura</button>
  <p id="selectedTemperature"></p>
  <div>
    <canvas id="dailyAverageChart" width="400" height="200"></canvas>
  </div>

  <script>
    let temperatureData = [];
    const ctx = document.getElementById('temperatureChart').getContext('2d');
    const dailyCtx = document.getElementById('dailyAverageChart').getContext('2d');
    let temperatureChart;
    let dailyAverageChart;

    // Cambia la URL aquí con la de tu Google Apps Script
    const apiUrl = "https://script.google.com/macros/s/AKfycbxxZhvNEziuSdlFehugSzbOcmEvjFnFN7qoVjrxtlj3Ah4CkSJr_cy4ufak51bmNKS8ew/exec";

    // Función para obtener los datos desde Google Sheets a través del Apps Script
    async function fetchTemperatureData() {
      const response = await fetch(apiUrl); // Llamada a tu URL
      const data = await response.json();  // Datos devueltos como JSON

      // Formatear la fecha para mostrar solo el día
      temperatureData = data.map(entry => {
        return {
          fecha: new Date(entry.fecha).toISOString().split('T')[0], // Extrae solo la fecha
          temperatura: entry.temperatura
        };
      });

      createChart();
    }

    // Crear el gráfico de temperatura general
    function createChart() {
      const labels = temperatureData.map(entry => entry.fecha);
      const temperatures = temperatureData.map(entry => entry.temperatura);

      if (temperatureChart) {
        temperatureChart.destroy(); // Destruir gráfico previo si existe
      }

      temperatureChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Temperatura (°C)',
            data: temperatures,
            borderColor: 'rgba(75, 192, 192, 1)',
            fill: false
          }]
        },
        options: {
          scales: {
            x: { title: { display: true, text: 'Fecha' } },
            y: { title: { display: true, text: 'Temperatura (°C)' } }
          }
        }
      });
    }

    // Filtrar datos por fecha seleccionada y calcular el promedio
    function filterData() {
      const selectedDate = document.getElementById('datePicker').value;
      const filteredData = temperatureData.filter(entry => entry.fecha === selectedDate);

      if (filteredData.length > 0) {
        // Mostrar promedio en el texto
        const averageTemperature = filteredData.reduce((sum, entry) => sum + entry.temperatura, 0) / filteredData.length;
        document.getElementById('selectedTemperature').innerText = 
          `Temperatura promedio el ${selectedDate}: ${averageTemperature.toFixed(2)} °C`;

        // Crear gráfico del promedio
        createDailyAverageChart(selectedDate, averageTemperature);
      } else {
        document.getElementById('selectedTemperature').innerText = "No hay datos para esta fecha.";
        if (dailyAverageChart) {
          dailyAverageChart.destroy(); // Destruir el gráfico si no hay datos
        }
      }
    }

    // Crear gráfico de promedio diario
    function createDailyAverageChart(date, averageTemperature) {
      if (dailyAverageChart) {
        dailyAverageChart.destroy(); // Destruir gráfico previo si existe
      }

      dailyAverageChart = new Chart(dailyCtx, {
        type: 'bar',
        data: {
          labels: [date],
          datasets: [{
            label: 'Promedio de Temperatura (°C)',
            data: [averageTemperature],
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1
          }]
        },
        options: {
          scales: {
            y: { title: { display: true, text: 'Temperatura (°C)' }, beginAtZero: true }
          }
        }
      });
    }

    // Llamar la función para cargar los datos al cargar la página
    fetchTemperatureData();
  </script>
</body>
</html>

